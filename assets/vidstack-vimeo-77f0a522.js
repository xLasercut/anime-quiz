import{c as T,T as a,s as y,p as G,e as m,a as u,i as P,F as j,m as w,L as b,l as N,G as R,Q as q}from"./index-d7f2cca7.js";import{R as C}from"./vidstack-4jGm7oeB-a57fc69d.js";import{E as F,t as E}from"./vidstack-cgu9mlil-8e5b4bf2.js";const H=["bufferend","bufferstart","durationchange","ended","enterpictureinpicture","error","fullscreenchange","leavepictureinpicture","loaded","playProgress","loadProgress","pause","play","playbackratechange","qualitychange","seeked","seeking","timeupdate","volumechange","waiting"],r=class r extends F{constructor(){super(...arguments),this.$$PROVIDER_TYPE="VIMEO",this.scope=T(),this.Fa=0,this.Ga=new a(0,0),this.Hb=new a(0,0),this.E=null,this.G=null,this.rd=null,this.N=y(""),this.oc=y(!1),this.sd=null,this.V=null,this.eh=null,this.Da=new C(this.bd.bind(this)),this.cookies=!1,this.title=!0,this.byline=!0,this.portrait=!0,this.color="00ADEF"}get c(){return this.b.delegate.c}get type(){return"vimeo"}get currentSrc(){return this.V}get videoId(){return this.N()}get hash(){return this.sd}get isPro(){return this.oc()}preconnect(){const e=[this.eb(),"https://i.vimeocdn.com","https://f.vimeocdn.com","https://fresnel.vimeocdn.com"];for(const t of e)G(t,"preconnect")}setup(e){this.b=e,super.setup(e),m(this.kd.bind(this)),m(this.fh.bind(this)),m(this.gh.bind(this)),this.c("provider-setup",this)}destroy(){this.H(),this.q("destroy")}async play(){const{paused:e}=this.b.$state;if(u(e))return this.E||(this.E=E(()=>{if(this.E=null,e())return"Timed out."}),this.q("play")),this.E.promise}async pause(){const{paused:e}=this.b.$state;if(!u(e))return this.G||(this.G=E(()=>{if(this.G=null,!e())return"Timed out."}),this.q("pause")),this.G.promise}setMuted(e){this.q("setMuted",e)}setCurrentTime(e){this.q("seekTo",e)}setVolume(e){this.q("setVolume",e),this.q("setMuted",u(this.b.$state.muted))}setPlaybackRate(e){this.q("setPlaybackRate",e)}async loadSource(e){if(!P(e.src)){this.V=null,this.sd=null,this.N.set("");return}const t=e.src.match(r.jd),s=t==null?void 0:t[1],i=t==null?void 0:t[2];this.N.set(s??""),this.sd=i??null,this.V=e}kd(){this.H();const e=this.N();if(!e){this.cb.set("");return}this.cb.set(`${this.eb()}/video/${e}`)}fh(){const e=this.cb(),t=this.N(),s=r.dh,i=s.get(t);if(!t)return;const n=j();if(this.rd=n,i){n.resolve(i);return}const o=`https://vimeo.com/api/oembed.json?url=${e}`,c=new AbortController;return window.fetch(o,{mode:"cors",signal:c.signal}).then(h=>h.json()).then(h=>{var v,k;const p=/vimeocdn.com\/video\/(.*)?_/,l=(k=(v=h==null?void 0:h.thumbnail_url)==null?void 0:v.match(p))==null?void 0:k[1],f=l?`https://i.vimeocdn.com/video/${l}_1920x1080.webp`:"",d={title:(h==null?void 0:h.title)??"",duration:(h==null?void 0:h.duration)??0,poster:f,pro:h.account_type!=="basic"};s.set(t,d),n.resolve(d)}).catch(h=>{n.reject(),this.c("error",{message:`Failed to fetch vimeo video info from \`${o}\`.`,code:1,error:w(h)})}),()=>{n.reject(),c.abort()}}gh(){const e=this.oc(),{$state:t,qualities:s}=this.b;if(t.canSetPlaybackRate.set(e),s[b.Mc](!e),e)return N(s,"change",()=>{var n;if(s.auto)return;const i=(n=s.selected)==null?void 0:n.id;i&&this.q("setQuality",i)})}eb(){return"https://player.vimeo.com"}Te(){const{$iosControls:e}=this.b,{keyDisabled:t}=this.b.$props,{controls:s,playsinline:i}=this.b.$state,n=s()||e();return{title:this.title,byline:this.byline,color:this.color,portrait:this.portrait,controls:n,h:this.hash,keyboard:n&&!t(),transparent:!0,playsinline:i(),dnt:!this.cookies}}bd(){this.q("getCurrentTime")}Eb(e,t){const{currentTime:s,paused:i,seeking:n,bufferedEnd:o}=this.b.$state;if(n()&&i()&&(this.q("getBuffered"),o()>e&&this.c("seeked",e,t)),s()===e)return;const c=s(),h={currentTime:e,played:this.Fa>=e?this.Ga:this.Ga=new a(0,this.Fa=e)};this.c("time-update",h,t),Math.abs(c-e)>1.5&&(this.c("seeking",e,t),!i()&&o()<e&&this.c("waiting",void 0,t))}bb(e,t){this.c("seeked",e,t)}md(e){var s;const t=this.N();(s=this.rd)==null||s.promise.then(i=>{if(!i)return;const{title:n,poster:o,duration:c,pro:h}=i,{$iosControls:p}=this.b,{controls:l}=this.b.$state,f=l()||p();this.Da.Bb(),this.oc.set(h),this.Hb=new a(0,c),this.c("poster-change",o,e),this.c("title-change",n,e),this.c("duration-change",c,e);const d={buffered:new a(0,0),seekable:this.Hb,duration:c};this.b.delegate.jc(d,e),f||this.q("_hideOverlay"),this.q("getQualities")}).catch(i=>{t===this.N()&&this.c("error",{message:"Failed to fetch oembed data",code:2,error:w(i)})})}hh(e,t,s){switch(e){case"getCurrentTime":this.Eb(t,s);break;case"getBuffered":R(t)&&t.length&&this.Ye(t[t.length-1][1],s);break;case"setMuted":this.ab(u(this.b.$state.volume),t,s);break;case"getChapters":break;case"getQualities":this.pc(t,s);break}}ih(){for(const e of H)this.q("addEventListener",e)}Aa(e){var t;this.c("pause",void 0,e),(t=this.G)==null||t.resolve(),this.G=null}xb(e){var t;this.c("play",void 0,e),(t=this.E)==null||t.resolve(),this.E=null}jh(e){const{paused:t}=this.b.$state;t()||this.c("playing",void 0,e)}Ye(e,t){const s={buffered:new a(0,e),seekable:this.Hb};this.c("progress",s,t)}kh(e){this.c("waiting",void 0,e)}lh(e){const{paused:t}=this.b.$state;t()||this.c("playing",void 0,e)}dd(e){const{paused:t}=this.b.$state;t()&&this.c("play",void 0,e),this.c("waiting",void 0,e)}ab(e,t,s){const i={volume:e,muted:t};this.c("volume-change",i,s)}pc(e,t){this.b.qualities[q.Za]=e.some(s=>s.id==="auto")?()=>{this.q("setQuality","auto")}:void 0;for(const s of e){if(s.id==="auto")continue;const i=+s.id.slice(0,-1);isNaN(i)||this.b.qualities[b.oa]({id:s.id,width:i*(16/9),height:i,codec:"avc1,h.264",bitrate:-1},t)}this.fb(e.find(s=>s.active),t)}fb({id:e}={},t){if(!e)return;const s=e==="auto",i=this.b.qualities.toArray().find(n=>n.id===e);s?(this.b.qualities[q.Ya](s,t),this.b.qualities[b.pa](void 0,!0,t)):this.b.qualities[b.pa](i,!0,t)}mh(e,t,s){switch(e){case"ready":this.ih();break;case"loaded":this.md(s);break;case"play":this.xb(s);break;case"playProgress":this.jh(s);break;case"pause":this.Aa(s);break;case"loadProgress":this.Ye(t.seconds,s);break;case"waiting":this.dd(s);break;case"bufferstart":this.kh(s);break;case"bufferend":this.lh(s);break;case"volumechange":this.ab(t.volume,u(this.b.$state.muted),s);break;case"durationchange":this.Hb=new a(0,t.duration),this.c("duration-change",t.duration,s);break;case"playbackratechange":this.c("rate-change",t.playbackRate,s);break;case"qualitychange":this.fb(t,s);break;case"fullscreenchange":this.c("fullscreen-change",t.fullscreen,s);break;case"enterpictureinpicture":this.c("picture-in-picture-change",!0,s);break;case"leavepictureinpicture":this.c("picture-in-picture-change",!1,s);break;case"ended":this.c("end",void 0,s);break;case"error":this.U(t,s);break;case"seeked":this.bb(t.seconds,s);break}}U(e,t){var s;if(e.method==="play"){(s=this.E)==null||s.reject(e.message);return}}hd(e,t){e.event?this.mh(e.event,e.data,t):e.method&&this.hh(e.method,e.value,t)}lc(){}q(e,t){return this.gd({method:e,value:t})}H(){this.Da.ra(),this.Fa=0,this.Ga=new a(0,0),this.Hb=new a(0,0),this.E=null,this.G=null,this.rd=null,this.eh=null,this.oc.set(!1)}};r.jd=/(?:https:\/\/)?(?:player\.)?vimeo(?:\.com)?\/(?:video\/)?(\d+)(?:\?hash=(.*))?/,r.dh=new Map;let $=r;export{$ as VimeoProvider};
