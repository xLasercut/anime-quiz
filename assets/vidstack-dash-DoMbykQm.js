var vt=Object.defineProperty;var z=n=>{throw TypeError(n)};var wt=(n,t,e)=>t in n?vt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var H=(n,t,e)=>wt(n,typeof t!="symbol"?t+"":t,e),Q=(n,t,e)=>t.has(n)||z("Cannot "+e);var i=(n,t,e)=>(Q(n,t,"read from private field"),e?e.call(n):t.get(n)),f=(n,t,e)=>t.has(n)?z("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(n):t.set(n,e),p=(n,t,e,r)=>(Q(n,t,"write to private field"),r?r.call(n,e):t.set(n,e),e),h=(n,t,e)=>(Q(n,t,"access private method"),e);import{bA as Et,b9 as q,bt as Lt,be as At,bu as Y,bg as J,b3 as Dt,bi as C,bv as bt,br as I,bq as xt,bj as P,bB as Mt,bC as Ct,bm as Nt,bw as Rt,bl as Z,bx as Ft,by as Pt,bz as qt}from"./index-BQ0TV-HT.js";import{VideoProvider as _t}from"./vidstack-video-BBoNPtrs.js";import{R as $t}from"./vidstack-DqAw8m9J-DKFUg7Nx.js";import"./vidstack-Bq6c3Bam-7o5proz3.js";function W(n){try{return new Intl.DisplayNames(navigator.languages,{type:"language"}).of(n)??null}catch{return null}}const jt=n=>`dash-${bt(n)}`;var L,d,o,N,R,s,b,k,tt,it,w,F,et,st,nt,rt,ot,at,ht,dt,A,ut,O,G,ct,V,lt,pt,B;class Ht{constructor(t,e){f(this,s);f(this,L);f(this,d);f(this,o,null);f(this,N,new Set);f(this,R,null);H(this,"config",{});f(this,w,null);f(this,F,{});f(this,A,-1);p(this,L,t),p(this,d,e)}get instance(){return i(this,o)}setup(t){p(this,o,t().create());const e=h(this,s,it).bind(this);for(const r of Object.values(t.events))i(this,o).on(r,e);i(this,o).on(t.events.ERROR,h(this,s,at).bind(this));for(const r of i(this,N))r(i(this,o));i(this,d).player.dispatch("dash-instance",{detail:i(this,o)}),i(this,o).initialize(i(this,L),void 0,!1),i(this,o).updateSettings({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}},...this.config}),i(this,o).on(t.events.FRAGMENT_LOADING_STARTED,h(this,s,ht).bind(this)),i(this,o).on(t.events.FRAGMENT_LOADING_COMPLETED,h(this,s,dt).bind(this)),i(this,o).on(t.events.MANIFEST_LOADED,h(this,s,ot).bind(this)),i(this,o).on(t.events.QUALITY_CHANGE_RENDERED,h(this,s,rt).bind(this)),i(this,o).on(t.events.TEXT_TRACKS_ADDED,h(this,s,st).bind(this)),i(this,o).on(t.events.TRACK_CHANGE_RENDERED,h(this,s,nt).bind(this)),i(this,d).qualities[Y.enableAuto]=h(this,s,ct).bind(this),J(i(this,d).qualities,"change",h(this,s,lt).bind(this)),J(i(this,d).audioTracks,"change",h(this,s,pt).bind(this)),p(this,R,Dt(h(this,s,k).bind(this)))}onInstance(t){return i(this,N).add(t),()=>i(this,N).delete(t)}loadSource(t){var e;h(this,s,B).call(this),q(t.src)&&((e=i(this,o))==null||e.attachSource(t.src))}destroy(){var t,e;h(this,s,B).call(this),(t=i(this,o))==null||t.destroy(),p(this,o,null),(e=i(this,R))==null||e.call(this),p(this,R,null)}}L=new WeakMap,d=new WeakMap,o=new WeakMap,N=new WeakMap,R=new WeakMap,s=new WeakSet,b=function(t){return new C(jt(t.type),{detail:t})},k=function(){if(!i(this,d).$state.live())return;const t=new $t(h(this,s,tt).bind(this));return t.start(),t.stop.bind(t)},tt=function(){if(!i(this,o))return;const t=i(this,o).duration()-i(this,o).time();i(this,d).$state.liveSyncPosition.set(isNaN(t)?1/0:t)},it=function(t){var e;(e=i(this,d).player)==null||e.dispatch(h(this,s,b).call(this,t))},w=new WeakMap,F=new WeakMap,et=function(t){var u;const e=(u=i(this,w))==null?void 0:u[I.native],r=(e==null?void 0:e.track).cues;if(!e||!r)return;const l=i(this,w).id,g=i(this,F)[l]??0,y=h(this,s,b).call(this,t);for(let m=g;m<r.length;m++){const c=r[m];c.positionAlign||(c.positionAlign="auto"),i(this,w).addCue(c,y)}i(this,F)[l]=r.length},st=function(t){var g;if(!i(this,o))return;const e=t.tracks,r=[...i(this,L).textTracks].filter(y=>"manualMode"in y),l=h(this,s,b).call(this,t);for(let y=0;y<r.length;y++){const u=e[y],m=r[y],c=`dash-${u.kind}-${y}`,E=new xt({id:c,label:(u==null?void 0:u.label)??((g=u.labels.find(a=>a.text))==null?void 0:g.text)??((u==null?void 0:u.lang)&&W(u.lang))??(u==null?void 0:u.lang)??void 0,language:u.lang??void 0,kind:u.kind,default:u.defaultTrack});E[I.native]={managed:!0,track:m},E[I.readyState]=2,E[I.onModeChange]=()=>{i(this,o)&&(E.mode==="showing"?(i(this,o).setTextTrack(y),p(this,w,E)):(i(this,o).setTextTrack(-1),p(this,w,null)))},i(this,d).textTracks.add(E,l)}},nt=function(t){const{mediaType:e,newMediaInfo:r}=t;if(e==="audio"){const l=i(this,d).audioTracks.getById(`dash-audio-${r.index}`);if(l){const g=h(this,s,b).call(this,t);i(this,d).audioTracks[P.select](l,!0,g)}}},rt=function(t){if(t.mediaType!=="video")return;const e=i(this,d).qualities[t.newQuality];if(e){const r=h(this,s,b).call(this,t);i(this,d).qualities[P.select](e,!0,r)}},ot=function(t){if(i(this,d).$state.canPlay()||!i(this,o))return;const{type:e,mediaPresentationDuration:r}=t.data,l=h(this,s,b).call(this,t);i(this,d).notify("stream-type-change",e!=="static"?"live":"on-demand",l),i(this,d).notify("duration-change",r,l),i(this,d).qualities[Y.setAuto](!0,l);const g=i(this,o).getVideoElement(),y=i(this,o).getTracksForTypeFromManifest("video",t.data),u=[...new Set(y.map(a=>a.mimeType))].find(a=>a&&Mt(g,a)),m=y.filter(a=>u===a.mimeType)[0];let c=i(this,o).getTracksForTypeFromManifest("audio",t.data);const E=[...new Set(c.map(a=>a.mimeType))].find(a=>a&&Ct(g,a));if(c=c.filter(a=>E===a.mimeType),m.bitrateList.forEach((a,j)=>{var M;const U={id:((M=a.id)==null?void 0:M.toString())??`dash-bitrate-${j}`,width:a.width??0,height:a.height??0,bitrate:a.bandwidth??0,codec:m.codec,index:j};i(this,d).qualities[P.add](U,l)}),Nt(m.index)){const a=i(this,d).qualities[m.index];a&&i(this,d).qualities[P.select](a,!0,l)}c.forEach((a,j)=>{const M=a.labels.find(K=>navigator.languages.some(St=>K.lang&&St.toLowerCase().startsWith(K.lang.toLowerCase())))||a.labels[0],Tt={id:`dash-audio-${a==null?void 0:a.index}`,label:(M==null?void 0:M.text)??(a.lang&&W(a.lang))??a.lang??"",language:a.lang??"",kind:"main",mimeType:a.mimeType,codec:a.codec,index:j};i(this,d).audioTracks[P.add](Tt,l)}),g.dispatchEvent(new C("canplay",{trigger:l}))},at=function(t){const{type:e,error:r}=t;switch(r.code){case 27:h(this,s,ut).call(this,r);break;default:h(this,s,G).call(this,r);break}},ht=function(){i(this,A)>=0&&h(this,s,O).call(this)},dt=function(t){t.mediaType==="text"&&requestAnimationFrame(h(this,s,et).bind(this,t))},A=new WeakMap,ut=function(t){var e;h(this,s,O).call(this),(e=i(this,o))==null||e.play(),p(this,A,window.setTimeout(()=>{p(this,A,-1),h(this,s,G).call(this,t)},5e3))},O=function(){clearTimeout(i(this,A)),p(this,A,-1)},G=function(t){i(this,d).notify("error",{message:t.message??"",code:1,error:t})},ct=function(){var e;h(this,s,V).call(this,"video",!0);const{qualities:t}=i(this,d);(e=i(this,o))==null||e.setQualityFor("video",t.selectedIndex,!0)},V=function(t,e){var r;(r=i(this,o))==null||r.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:e}}}})},lt=function(){const{qualities:t}=i(this,d);!i(this,o)||t.auto||!t.selected||(h(this,s,V).call(this,"video",!1),i(this,o).setQualityFor("video",t.selectedIndex,t.switch==="current"),Rt&&(i(this,L).currentTime=i(this,L).currentTime))},pt=function(){if(!i(this,o))return;const{audioTracks:t}=i(this,d),e=i(this,o).getTracksFor("audio").find(r=>t.selected&&t.selected.id===`dash-audio-${r.index}`);e&&i(this,o).setCurrentTrack(e)},B=function(){h(this,s,O).call(this),p(this,w,null),p(this,F,{})};var x,S,_,v,gt,ft,yt,mt;class It{constructor(t,e,r){f(this,v);f(this,x);f(this,S);f(this,_);p(this,x,t),p(this,S,e),p(this,_,r),h(this,v,gt).call(this)}}x=new WeakMap,S=new WeakMap,_=new WeakMap,v=new WeakSet,gt=async function(){const t={onLoadStart:h(this,v,ft).bind(this),onLoaded:h(this,v,yt).bind(this),onLoadError:h(this,v,mt).bind(this)};let e=await Qt(i(this,x),t);if(Z(e)&&!q(i(this,x))&&(e=await Ot(i(this,x),t)),!e)return null;if(!window.dashjs.supportsMediaSource()){const r="[vidstack] `dash.js` is not supported in this environment";return i(this,S).player.dispatch(new C("dash-unsupported")),i(this,S).notify("error",{message:r,code:4}),null}return e},ft=function(){i(this,S).player.dispatch(new C("dash-lib-load-start"))},yt=function(t){i(this,S).player.dispatch(new C("dash-lib-loaded",{detail:t})),i(this,_).call(this,t)},mt=function(t){const e=Ft(t);i(this,S).player.dispatch(new C("dash-lib-load-error",{detail:e})),i(this,S).notify("error",{message:e.message,code:4,error:e})};async function Ot(n,t={}){var e,r,l,g,y,u,m;if(!Z(n)){if((e=t.onLoadStart)==null||e.call(t),Gt(n))return(r=t.onLoaded)==null||r.call(t,n),n;if(X(n)){const c=n.MediaPlayer;return(l=t.onLoaded)==null||l.call(t,c),c}try{const c=(g=await n())==null?void 0:g.default;if(X(c))return(y=t.onLoaded)==null||y.call(t,c.MediaPlayer),c.MediaPlayer;if(c)(u=t.onLoaded)==null||u.call(t,c);else throw Error("");return c}catch(c){(m=t.onLoadError)==null||m.call(t,c)}}}async function Qt(n,t={}){var e,r,l;if(q(n)){(e=t.onLoadStart)==null||e.call(t);try{if(await Pt(n),!qt(window.dashjs.MediaPlayer))throw Error("");const g=window.dashjs.MediaPlayer;return(r=t.onLoaded)==null||r.call(t,g),g}catch(g){(l=t.onLoadError)==null||l.call(t,g)}}}function Gt(n){return n&&n.prototype&&n.prototype!==Function}function X(n){return n&&"MediaPlayer"in n}const Vt="https://cdn.jsdelivr.net";var $,T,D;class Bt extends _t{constructor(){super(...arguments);H(this,"$$PROVIDER_TYPE","DASH");f(this,$,null);f(this,T,new Ht(this.video,this.ctx));f(this,D,`${Vt}/npm/dashjs@4.7.4/dist/dash.all.min.js`)}get ctor(){return i(this,$)}get instance(){return i(this,T).instance}get type(){return"dash"}get canLiveSync(){return!0}get config(){return i(this,T).config}set config(e){i(this,T).config=e}get library(){return i(this,D)}set library(e){p(this,D,e)}preconnect(){q(i(this,D))&&Lt(i(this,D))}setup(){super.setup(),new It(i(this,D),this.ctx,e=>{p(this,$,e),i(this,T).setup(e),this.ctx.notify("provider-setup",this);const r=At(this.ctx.$state.source);r&&this.loadSource(r)})}async loadSource(e,r){if(!q(e.src)){this.removeSource();return}this.media.preload=r||"",this.appendSource(e,"application/x-mpegurl"),i(this,T).loadSource(e),this.currentSrc=e}onInstance(e){const r=i(this,T).instance;return r&&e(r),i(this,T).onInstance(e)}destroy(){i(this,T).destroy()}}$=new WeakMap,T=new WeakMap,D=new WeakMap,H(Bt,"supported",Et());export{Bt as DASHProvider};
